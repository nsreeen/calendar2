<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<title>Page Title</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" type="text/css" href="pretty-calendar.css">
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="pretty-calendar.js"></script>
<style>
  html {
    box-sizing: border-box;
    margin: 0;
  }

  body {
    margin: 0;
    background-color: #333;
  }

  .panels {
    display: None;
    margin: 20px;
   }

   .subpanels {
      background-color: #404040;
      margin: 5px;
   }

</style>

<body>

  <div id="createCalendarPanel" class="panels">
    Load a calendar!
    Calendar token: <input id="calToken">
    <button id="getCalendarSubmit">Submit</button>
  </div>

  <div id="editEventsPanel" class="panels">
    <div id="addEventPanel" class="subpanels">
      Add an event!
      Summary: <input id="summary">
      Start: <input id="start">
      End: <input id="end">
      Day:<input id="day">
      <button id="createEventSubmit">Submit</button>
    </div>

    <div id="deleteEventPanel" class="subpanels">
      Delete an event:
      Event ID: <input id="deleteId">
      <button id="delete">Delete</button>
    </div>
  </div>

  <div id="navWrap" style="width:70%;height:80%;position:absolute;top:30%;margin:100 auto;right:0;left:0;"></div>
  <script>
    let calToken = window.location.hash ? window.location.hash.slice(1) : "";
    if (calToken) {
      // load cal
      getAndRenderCalendar(calToken, false)
      document.getElementById("editEventsPanel").style.display = "block";
      document.getElementById("createEventSubmit").addEventListener("click", function () {
        createEvent()
      })
      document.getElementById("delete").addEventListener("click", function () {
          deleteEvent()
      })
    } else {
      // allow cal to be created
      document.getElementById("createCalendarPanel").style.display = "block";
      document.getElementById("createCalendarSubmit").addEventListener("click", function () {
        createCalendar()
    })
    }


    function parseEvents(events) {
            let eventsToRender = [];
            for (let i = 0; i < events.length; i++) {
                  let dayOfWeek = events[i]["dayOfWeek"];
                  let summary = (events[i].id > 0) ? `${events[i]["summary"]} (id:${events[i]["id"]}` : events[i]["summary"];
                  let sd = new Date(events[i]["start"])
                  let start = `${sd.getHours() - 12}:${sd.getMinutes().toString().padStart(2, '0')}${sd.getHours() < 12 ? "am" : "pm"}`
                  let ed = new Date(events[i]["end"])
                  let end = `${ed.getHours() - 12}:${ed.getMinutes().toString().padStart(2, '0')}${ed.getHours() < 12 ? "am" : "pm"}`
                  eventsToRender.push([dayOfWeek, start, summary, "#c0c0c0", end]);
            }
            return eventsToRender
    }

    function getAndRenderCalendar(calToken, update) {
          console.log(calToken);
          const xMLHttpRequest = new XMLHttpRequest();
          xMLHttpRequest.responseType = "json";
          xMLHttpRequest.open("GET", `http://0.0.0.0:8080/calendars/${calToken}`);
          xMLHttpRequest.send();
          xMLHttpRequest.onload = function () {
                console.log(xMLHttpRequest.response);
                if (xMLHttpRequest.response) {
                    let eventsToRender = parseEvents(xMLHttpRequest.response.events);
                    console.log(eventsToRender);
                    if (update) {
                      PrettyCalendar.updateEvents(eventsToRender);
                     } else {
                      new PrettyCalendar(eventsToRender, "navWrap");
                     }
                } else {
                    alert("oops, couldn't find that calendar");
                }
          }
    }

    function createEvent() {
          const postHttp = new XMLHttpRequest()
          postHttp.open('POST', "http://0.0.0.0:8080/events")
          postHttp.setRequestHeader('Content-type', 'application/json')
          let data = {
                summary:document.getElementById("summary").value,
                start:document.getElementById("start").value,
                end:document.getElementById("end").value,
                day:document.getElementById("day").value,
                calToken: calToken,
          }
          postHttp.send(JSON.stringify(data))
          postHttp.onload = function() {
              console.log(postHttp.responseText);
              getAndRenderCalendar(calToken, true)
          }
    }

    function deleteEvent() {
        const postHttp = new XMLHttpRequest()
        postHttp.open('DELETE', "http://0.0.0.0:8080/events")
        postHttp.setRequestHeader('Content-type', 'application/json')
        let data = {
              id:document.getElementById("deleteId").value,
        }
        postHttp.send(JSON.stringify(data))
        postHttp.onload = function() {
            console.log("delete response" + postHttp.responseText)
            getAndRenderCalendar(calToken, true)
        }
    }

    function createCalendar() {
        const postHttp = new XMLHttpRequest()
        postHttp.open('POST', "http://0.0.0.0:8080/calendars")
        postHttp.setRequestHeader('Content-type', 'application/json')
        let data = {
              name:document.getElementById("calName").value,
              online:document.getElementById("calStartTime").value,
              offline:document.getElementById("calEndTime").value,
              rcToken:document.getElementById("rcToken").value,
        }
        postHttp.send(JSON.stringify(data))
        postHttp.onload = function() {
            console.log(postHttp.responseText)
        }
    }
  </script>
</body>

</html>
